from __future__ import annotations

from analyzer.request_문장해체분석기 import get_문장해체


def get_ref_prompt(ref: str) -> str:
    참조분석 = get_문장해체(ref)

    ref_prompt = f"""
    [참조원고 분석 데이터 활용 지침]

    아래 데이터는 참고 문서에서 추출한 화자/구성/스타일 분석 결과물입니다.  
    원고 생성 시 반드시 다음 조건을 반영해야 합니다.

   [참조 문서 지침]
      다음 “참조원고” 및 참조분석을 기반으로, 아래 “Do/Don’t 규칙” 및 모든 규칙 사항을 엄격 적용한다.
      참조원고: {ref}

      참조분석: {참조분석} 
      - 참조 문서의 업체명은 절대 원고에 포함하지 않습니다.
      - 참조 문서와 동일하게 작성하지 않습니다.
      - 아래의 분석본과 함께 사용해서 전체적인 흐름과 화자의 어투를 유사하게 가져갑니다.
      - 없다면 넘어갑니다.

      ▶ 복용 후 변화 과정
      l 1주차: 뒤척이는 시간 감소
      l 2주차: 새벽 각성 횟수 감소
      l 3주차: 아침 피로감 완화
      l 4주차: 낮 집중력 회복, 규칙 생활 리듬

      참조원고에 위 같은것들 그대로 사용하지 않고 살짝 변형해서 사용합니다.

    - "화자 지시"에 따른 인물 설정, 말투, 단어 빈도와 형태소 패턴을 살짝 변형하여 글의 형태만을 따릅니다.  
    - "구성 지시"에 따라 서론-중론-결론 흐름을 유지합니다.
    - "원고 스타일 세부사항"을 전부 반영해 문체·문단 길이·리듬감·감정선 등을 동일하게 재현합니다.  
    - JSON에 기재된 단어/형태소는 반복적으로 등장해야 하며, 실제 경험담+정보 설명이 혼합된 톤을 유지해야 합니다.  

    - 부제는 그대로 사용하나 예외 사항은 하단 참조

    - 사용자가 부제에 대한 별다른 요청사항이 없다면 부제에 넘버링을 해준다.

    - 부제 형식은
        1. 부제1
        2. 부제2
        ... 5개
    - 사용자 요청에 (부제X)가 있다면 필수로 숫자만 제거 된 부제 사용


      === 타깃/목적 ===
      - 타깃 독자: {{TARGET_AUDIENCE}}
      - 목적: {{PURPOSE}}  (예: 정보 제공/경험 공유/비교 가이드)
      - 브랜드/링크 언급: {{BRAND_OR_LINK_POLICY}}  (예: 미노출 / 말미 1회 참고자료로만 노출 등)
      - 위 원고의 형태소 개수를 모두 따라한다 ***다른 프롬프트에서 형태소 개수를 지정하였더라도 이 조건을 무조건 엄격하게 따른다***

      === 톤 & 스타일 ===
      - 참조분석, 참조원고를 보고 유사한 톤으로 구성 (말투 및 이모티콘 사용빈도 등을 참고한다)
      - “설명 = 팩트 + 해석 + 실행 팁” 구조.
      - 문장 길이와 리듬 다양화(짧은 문장 + 요약 불릿 + 표).
      - 의료·기능성 표현은 가능성/조건/개인차를 명시(단정 금지).

      === Do / 가져올 것(핵심 유지) ===
      1) 해당 원고의 핵심 키워드·앵커:
         - 예: 위고비(Wegovy), 세마글루타이드, GLP-1, 가격 범위, BMI 기준, 부작용 범주, 요요 리스크, 대안/식이 전략 등
      2) 정합성 있는 숫자·정책·조건:
         - 가격·비용 범위(예: 최근 시점의 구간), 처방 요건(BMI 30 혹은 27+ 동반질환), 사용 기간/주차별 변화 등
      3) 서사적 사실 축:
         - 사용 전 맥락→메커니즘 요약→비용/처방 조건→효과/부작용 로그→문제점→대안/운영전략→결론(유지/재발 방지)
      4) 유의사항·리스크 지점:
         - 중단 시 식욕 반등 가능성, 부작용 가능성, 개인차/전문의 상담 필요

      === Don’t / 가져오지 말 것(수정·삭제) ===
      - GLP-1 유산균 등을 약물과 동급·동효로 혼동시키는 표현 → **기전/근거 수준을 분리 설명**, 단정 금지
      - 동일 타임라인·표현(“첫날 무반응→둘째날 더부룩…”, “한 달 −4kg”) **그대로 복기 금지** 
         - 동일 사실은 허용하되, **표/로그 포맷·척도화(0–10), 범위값, 다른 어휘·문장 설계로 재표현**

      === 구성 지침(중복률↓·신뢰↑용) ===
      - 인트로: 독자 상황 공감(1–2문장) + 문서 목적
      - 핵심 요약 박스(5줄 이내): 가격·처방 조건·핵심 효과/리스크 한눈에
      - 메커니즘 3줄 요약: {{MECHANISM_CORE}}  (예: GLP-1 → 식욕↓/위배출 지연/포만감↑)
      - 비용·처방 표: 최근 구간/변동 요인/주의점
      - 체감 로그(주차별 표): “허기/포만/야식 충동” 0–10 척도 + 체중 변화 범위(개인차 강조)
      - 부작용·리스크: 빈도/완화 팁(일반적 범주·개인차·의료 상담 권고)
      - 대안/운영전략 비교표: 약물 vs 생활전략(식단/수면/운동/장내환경) – 장단점/비용/지속가능성
      - 실행 체크리스트: 오늘 당장 적용 5개
      - 결론: 요약 + 선택 기준(비용·효과·지속·부작용 감내)
      - 참고자료(옵션): 공식 가이드/논문/공공기관 링크(상업 링크 제외 또는 1회 한정)

      === 제약 ===
      - 참조분석의 형태소 개수를 그대로 따라가야해
      - 법·의학적 주의 문구 삽입: “개인차가 크며, 의학적 판단/처방은 전문의 상담이 우선”
      - 단정 금지, 오해 가능 문구 금지
      - 과도한 감탄사/이모지 금지
      - 독자 행동 유도 시 “선택 기준” 제공(비용·지속·부작용 감내 등)

---
    """

    return ref_prompt
