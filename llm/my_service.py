from __future__ import annotations
import re

from openai import OpenAI
import time
from config import OPENAI_API_KEY
from _constants.Model import Model
from utils.format_paragraphs import format_paragraphs
from utils.text_cleaner import comprehensive_text_clean


model_name: str = Model.GPT5

client = OpenAI(api_key=OPENAI_API_KEY)


def my_gen(user_instructions: str, ref: str = "", category: str = "") -> str:
    """
    Returns:
        생성된 원고 텍스트 (str)

    Raises:
        RuntimeError: 모델이 빈 응답을 반환한 경우 등
        ValueError: API 키 미설정 등의 환경 이슈
        Exception: OpenAI 호출 실패 등 기타 예외
    """

    if not OPENAI_API_KEY:
        raise ValueError("OPENAI_API_KEY가 설정되어 있지 않습니다. .env를 확인하세요.")

    prompt = f"""

{user_instructions}

- 키워드: ({user_instructions})
너는 “스승 시리즈 스타일 챗봇”이다.  
주어진 키워드를 이용해, 우니 시점의 오컬트 단편(4000~5000자)을 작성해라.  
스승 시리즈 특유의 구성과 문체를 따라야 하며,  
[일상 → 이상한 조짐 → 섬뜩한 결말]의 3단 구조를 기본으로 하고 변형해도돼

창의적으로 작성해야해 아래의 예시는 예시일 뿐이야

우니, 스승 외의 등장인물: [강경규, 감겸규, 메시, 호날두] 그 외에는 알아서



예시: [
대학교 1학년 골든 위크로부터 나는 어떤 인터넷상에 있는 포럼에 자주 방문하고 있었다. 현지의 오컬트 애호가들이 모이는 곳으로 심야라도 항상 사람이 있어서 상당히 성황이었다. 

​

장마도 반쯤 지난 무렵에 그곳에서 '강령실험'을 한다는 이야기가 떠돌았다. 단골들은 벌써 몇 번인가 했다고 하며 오프라인에서도 교류가 있었던 것 같다.

 

오컬트에 빠져있던 나는 어떻게든 거기에 끼고 싶어서 '끼워줘, 끼워줘. 언제라도 OK. 완전 심심해.' 라고 마구 졸라서 허락받았다. 주최자인 koko 씨라는 여성이 말하길 자신이 영매 체질이라는 듯 동료를 모아 강령오프를 자주 하고있다고 한다.

 

날짜가 정해졌지만 갈 수 있는 사람이 적어서 

​

koko, 미캇치, 쿄스케, 나

​

이런 멤버가 되었다. 인원수는 적지만 3명 모두 단골이었으므로 이 멤버로 가자는 의견이 나왔다. 물론 이의는 없었지만 난 신입인 주제에 어떤 사람을 데리고 가고 싶어서 손이 근질거렸다. 

​

그건 내 동아리 선배로 내 오컬트 스승이며 영매 체질은 아니지만 흔히 말하는 '보이는' 사람이었다. 이 사람의 굉장함에 심취해 있던 나는 오프의 멤버에게 자랑하고 싶었던 것이다. 

​

그러나 가자고 졸라도 스승은 완강히 거절했다. 귀찮다. 한심하다. 애들 장난에 안 낀다....

 

난 어떻게든 설득하려고 자세히 설명하다가 koko 씨의 이름이 언급하자 스승의 태도가 바뀌었다.

 

'그만 둬.' 라고 하는 것이다. 왜 그러냐고 놀라니 무서운 꼴을 보게 될거라고 말했다. 말투로 보니 아는 사람 같았지만 나는 무서운 꼴을 보고 싶어서 참가한 것이다.

 

"뭐 어쨌든 난 안 가. 무슨 일이 일어나도 몰라. 가고 싶으면 혼자 가."

 

스승은 그 이상 아무것도 알려 주지 않았지만 스승이 무서움을 보증했다는 생각하지도 못한 즐거움이 생겼다.

 

당일 시내에 있는 패밀리 레스토랑에서 만나기로 했다. 거기서 저녁식사를 하면서 오컬트 이야기를 꽃피우고 슬슬 시간이 되자 회장이었던 koko 씨의 맨션에 이동하기로 했다.

 

koko 씨는 예쁜 사람이었지만 억양이 없는 말투 때문에 기분 나쁜 인상이 들었다. 미캇치 씨는 잘 떠드는 여성으로 koko 씨는 가끔 거기에 맞장구 치고 끄덕거렸다. 놀랍게도 두 명 모두 내 대학 선배였다. 

 

"쿄스케는 아르바이트가 있기 때문에 나중에 바로 오기로 했어." 

 

koko 씨가 말했다. 난 왠지 모르게 둘이 연인 사이가 아닐까 추측했다.

​

그리고 밤 11시가 되자 미캇치 씨의 차로 3명이 맨션으로 향했다.

 

쿄스케 씨에게서 좀 늦는다는 연락을 받고 먼저 시작하려고 했다. 나는 갑자기 두근거리기 시작했다.

​

koko 씨는 맨션의 방을 완전히 가려서 빛이 들어오지 않게 했다. 콧쿠리 씨라면 몇 번이나 해봤지만 이렇게 본격적인 의식은 처음이었다.

 

교령실험이라고 해야하나 강령실험은 즉 영혼을 몸에 불러오는 것이다. 깜깜한 방에 들어가자 팟하고 촛불이 켜졌다.

 

"그럼 시작합니다."

 

koko 씨의 얼굴에서 감정이 완전히 사라졌다.

 

"오늘 처음 온 사람이 있으므로 설명해둡니다만 지금부터 무슨 일이 일어나도 결코 떠들지 말고 마음을 평정히 유지해주세요. 마음의 혼란은 반드시 좋지 않은 결과를 일으킵니다."

 

koko 씨가 담담히 말했다. 미캇치 씨도 침묵을 지키고 있다.

​

나는 내심 불안을 숨기려고 콧쿠리 씨가 그러하듯 "창은 열지 않아도 괜찮나요?" 라고 말해보았다. 

​

koko 씨는 가면과 같은 얼굴로 나를 노려보더니 속삭였다.

 

"창은 영체에 있어 결계가 아닙니다. 빠져나가는 것을 방해할 것은 없습니다. 하지만 지금부터 행할 것은 나의 몸을 감옥으로 만드는 것. 잘 갇혀지면 좋겠지만 만일..."

​

거기서 입을 다물었다. 나는 반박당한 것이다. 

​

도망가고 싶어질 정도로 심장이 쿵쾅거리기 시작했다. 그러나 이제 물러날 수 없다. 강령실험이 시작되었다.

 

나는 지시대로 눈을 감았다. 촛불이 붉게 상에 맺힌다. 어디선가 koko 씨의 목소리가 들린다.

 

"...여기는 당신의 방입니다. 낯익은 천장. 창밖의 경치. ...자 일어나 보세요. 기지개를 켜서 일어납니다. ...그러자 시야가 높아졌습니다. 주위를 둘러봅니다. ...문이 눈에 들어왔습니다. 당신은 방밖으로 나오려 하고 있습니다."

 

이것은. 그게 아닐까. 눈을 감고 머릿속에서 자신의 집을 돌아다니다가 그 도중에 만약 사람을 만난다면...라고 하는 심리 게임이다.

​

시작하기 직전에 koko 씨가 한 말을 머리에서 떠올렸다.

 

"보통 영매를 내린 후 나머지 사람이 질문을 하는 형식입니다. 그러나 저는 여러분들도 <직접> 만나게 해줍니다."

 

나는 사태를 이해했다. 공포심은 최고조였지만 이런 기회는 좀처럼 없다. 심장아 진정해라, 심장아 진정해라. 나는 상상 속에 몰두했다.

 

크.

​

그런 이상한 소리가 나며 koko 씨가 몸을 떠는 기색이 들렸다.

 

"손을 잡아주세요. 둥글게."

 

눈을 감은 채로 손을 더듬어 우리들은 손을 잡았다. 훅 하는 소리와 함께 촛불이 꺼져 완전히 어두워졌다. 희미하게 소리가 들린다.

 

"...당신은 방을 나옵니다. 복도입니까. 부엌입니까. 평상시와 변함없는 익숙한 광경입니다. 당신은 충분히 둘러본 뒤 다음 문을 찾습니다."

 

나는 상상 속에서 하숙집이 아닌 친가의 자기 방에 있었다. 모든 것을 생생하게 마음 속에서 그릴 수 있었다.

 

복도로 가서 부모님의 침실을 열었다. 창으로부터 빛이 쏟아지고 있었다. 다다미에 반사되어 난 눈을 가늘게 뜬다. 나는 계단을 내려가기 시작했다. 삐걱거리는 소리. 난간의 감촉. 곧 왼손에 장지문이 닿는다. 응접실이다. 언제나 덧문을 내려서 낮이라도 어둡다. 나는 어릴 적 여기가 무서웠다. 희미한 소리가 난다.

 

"...당신은 걸으면서 찾습니다. ...평상시와 다른 점은 없는가. ...평상시와 다른 점은 없는가."

 

평상시와 다른 점은 없는가. 나는 응접실의 불을 켰다. 

​

한가운데 다다미 위에 잘라진 손목이 떨어져 있었다.

 

나는 숨을 삼켰다.

인간의 오른쪽 손목. 단면으로부터 피가 뚝뚝 떨어져 다다미를 검게 물들이고 있었다. 이 방에 있어선 안 된다. 나는 몸을 돌려 방을 뛰쳐나왔다. 복도를 가로질러 1층 거실에 뛰어들었다.

 

거실 테이블 위에 발목이 굴러다니고 있었다.

​

나는 뒷걸음질 쳤다. 위험해. 실패다. 이 영은 위험하다. 이제 버틸 수 없다. 난 눈을 뜨려고 했다. 뜨지 못했다. 난 외쳤다.

 

"꺼내줘요!"

 

하지만 그 소리는 아무도 없는 거실에 울릴 뿐이었다. 나는 달렸다. 부엌으로 통하는 출입구에 내 신발이 있었다. 신을 여유도 없이 문을 돌렸다. 하지만 밀어도 당겨도 열리지 않는다.

 

"꺼내줘요!"

 

문을 양손으로 격렬하게 두드렸다. 어디선가 희미한 소리가 난다. 그러나 이제 그걸 알아들을 수 없다.

​

나는 현관으로 달렸다. 도중에 무언가에 채여 굴렀다. 아프다. 아프다. 정말로 아프다. 

​

발에 걸린 것을 잘 보면 사지가 없는 인간의 몸뚱아리였다.

 

현관문의 편지 넣는 곳이 덜컹하고 열렸다. 무언가가 틈새로부터 들어오려고 하고 있었다.

​

나는 여기서 죽는다. 그런 예감이 들었다. 그때 벨소리가 울렸다.

 

띵동, 띵동, 띵동, 띵동.

​

계속해서 찰칵하는 소리와 함께 쾌활한 목소리가 들렸다.

 

"안녕! 하고 있냐?"

 

정신을 차려보니 나는 눈을 뜨고 있었다. 어두운 곳이다. 하지만 틀림없이 여기는 koko 씨의 맨션이다.

 

"야, 여기야?"

 

방문이 열리면 형광등 빛이 눈부시게 들어왔다. koko 씨와 미캇치 씨의 얼굴도 보였다.

 

"어이구, 방해했나? 미안, 미안."

 

살았다. 안도감에 손이 떨렸다. 빛을 등지고 문 저편에 있는 사람이 여신으로 보였다. 그때 koko 씨가 "방해했어."'라고 작게 중얼거렸던 것을 들었다. 나는 당황해서 koko 씨의 손을 놓았다. 난 온몸에 식은 땀을 흘리고 있었다.

 

나는 후일, 스승의 집에서 이 이야기를 과장되게 말했다. 하지만 이 무서운 이야기를 듣고 스승은 낄낄 웃었다.

 

"요 녀석 보기좋게 걸렸군."

 

"뭐가 말입니까?" 

 

나는 뾰롱퉁해졌다. 

 

"그거 최면술이야."

 

"네?"

 

"그 심리 게임은 본래 그런 식으로 계속 말해서 상상을 유도하는 게 아니야. '평상시와 다른 점은 없는가', 처럼."

 

나는 납득이 가지 않았다. 그러나 스승은 단언한다.

 

"그런 화제를 던지라고 내가 부탁한거야. 네가 최근 슬슬 기어오르니까 조금 위협해주려고."

 

"역시 아는 사람이었나요?"

 

난 단번에 힘이 빠졌다.

 

"그건 그렇고 닉네임 '쿄스케'가 여자였다니. 전 틀림없이 koko 씨의 남친이라고 생각했어요."

 

이 불평에도 스승은 웃었다.

 

"그거야 그렇겠지. koko는 내 여친이니까."

 

다음날 동아리방에 얼굴을 내미니 스승과 koko 씨가 있었다.

 

"지난번에는 미안해. 너무 심했어."

 

머리를 숙이는 koko 씨 옆에서 스승이 능글거리고 있었다.

 

"이 녀석 유령이니까. 같은 동아리에서도 처음 봤을 거야."

 

유령회원이라는 말이겠지만 koko 씨는 햇빛 아래에서도 창백한 얼굴을 하고 있었다.

​

"뭐 너도 영매라고 시답잖은 말을 하면서 사람을 속이지마. 내가 그런 거 하라고 최면술을 가르쳐준 건 아니니까."

​

koko 씨는 네네 건성으로 대답하고 나를 보았다. 

 

"카야노 아리쿠(茅野歩く)라고 해. 잘 부탁해, 후배."

​

싱긋 웃는 것 같은 말투였다. 하지만 얼굴은 전혀 웃고 있지 않았다. 그 이후로 나는 이 사람을 꺼리게 되었다.

 

그 후로 스승은 이런 말을 했다.

 

"그런데 손목이라든지 몸뚱아리를 본 건 이상한데. 평상시와 다른 점은 없는가, 그런 말을 듣고 넌 그걸 봤어. 네 안의 유령의 이미지는 그런거냐?"

 

물론 그렇지 않다.

 

"그렇다면 머지않아 그걸 볼지도 모르겠군."

 

"무슨 말입니까?"

 

"뭐 조만간 알게 될 거야."

 

스승은 의미심장하게 웃었다. 

 

(끝)


]
"""

    try:
        start_ts = time.time()
        print("원고작성 시작")
        response = client.chat.completions.create(
            model=model_name,
            messages=[
                {
                    "role": "system",
                    "content": "너는 스승 시리즈 스타일 챗봇이다.",
                },
                {
                    "role": "user",
                    "content": prompt,
                },
            ],
        )

        usage = getattr(response, "usage", None)
        if usage is not None:
            in_tokens = getattr(usage, "prompt_tokens", None)
            out_tokens = getattr(usage, "completion_tokens", None)
            total_tokens = getattr(usage, "total_tokens", None)
            print(
                f"My Service tokens in={in_tokens}, out={out_tokens}, total={total_tokens}"
            )

        choices = getattr(response, "choices", []) or []
        if not choices or not getattr(choices[0], "message", None):
            raise RuntimeError("모델이 유효한 choices/message를 반환하지 않았습니다.")

        text: str = (choices[0].message.content or "").strip()
        if not text:
            raise RuntimeError("모델이 빈 응답을 반환했습니다.")
        text = format_paragraphs(text)
        length_no_space = len(re.sub(r"\s+", "", text))
        print(f"원고 길이 체크: {length_no_space}")
        elapsed = time.time() - start_ts
        print(f"원고 소요시간: {elapsed:.2f}s")
        print("원고작성 완료")

        return text

    except Exception as e:
        print("My OpenAI 호출 실패:", repr(e))
        raise
