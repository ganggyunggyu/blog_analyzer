from __future__ import annotations
from operator import le
import re


from anthropic import Anthropic
from openai import OpenAI
from xai_sdk.chat import system as grok_system_message
from xai_sdk.chat import user as grok_user_message
from _prompts.rules import line_break_rules
from _prompts.service.get_mongo_prompt import get_mongo_prompt
from _prompts.service.get_category_tone_rules import get_category_tone_rules
from _prompts.system.ver1 import V1
from config import (
    CLAUDE_API_KEY,
    GEMINI_API_KEY,
    GROK_API_KEY,
    OPENAI_API_KEY,
    UPSTAGE_API_KEY,
    grok_client,
    solar_client,
)
from _constants.Model import Model
from utils.query_parser import parse_query
from utils.text_cleaner import comprehensive_text_clean

from google import genai
from google.genai import types

from _prompts.rules.human_writing_style import human_writing_rule

from ai_lib.line_break_service import apply_line_break


model_name: str = Model.GROK_4_NON_RES


if model_name.startswith("gemini"):
    ai_service_type = "gemini"
elif model_name.startswith("claude"):
    ai_service_type = "claude"
elif model_name.startswith("solar"):
    ai_service_type = "solar"
elif model_name.startswith("grok"):
    ai_service_type = "grok"
else:
    ai_service_type = "openai"

openai_client = OpenAI(api_key=OPENAI_API_KEY) if ai_service_type == "openai" else None
gemini_client = (
    genai.Client(api_key=GEMINI_API_KEY) if ai_service_type == "gemini" else None
)
claude_client = (
    Anthropic(api_key=CLAUDE_API_KEY) if ai_service_type == "claude" else None
)


def grok_gen(user_instructions: str, ref: str = "", category: str = "") -> str:
    if ai_service_type == "solar":
        if not UPSTAGE_API_KEY:
            raise ValueError("UPSTAGE_API_KEY가 설정되어 있지 않습니다.")
    elif ai_service_type == "gemini":
        if not GEMINI_API_KEY:
            raise ValueError(
                "GEMINI_API_KEY가 설정되어 있지 않습니다. .env를 확인하세요."
            )
    elif ai_service_type == "openai":
        if not OPENAI_API_KEY:
            raise ValueError(
                "OPENAI_API_KEY가 설정되어 있지 않습니다. .env를 확인하세요."
            )
    elif ai_service_type == "grok":
        if not GROK_API_KEY:
            raise ValueError(
                "GROK_API_KEY가 설정되어 있지 않습니다. .env를 확인하세요."
            )

    parsed = parse_query(user_instructions)
    keyword, note = parsed.get("keyword", ""), parsed.get("note", "")

    if not keyword:
        raise ValueError("키워드가 없습니다.")
    if model_name == Model.GPT5_CHAT:
        target_chars_min, target_chars_max = 3000, 3200
    if model_name == Model.GPT4_1:
        target_chars_min, target_chars_max = 2400, 2600
    else:
        target_chars_min, target_chars_max = 1800, 2000

    mongo_data = get_mongo_prompt(category, user_instructions)
    category_tone_rules = get_category_tone_rules(category)

    length_rule = """## 글자 수 지침
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로
글자수 2000단어 이상 2300단어 이하 작성할것 씨빨럼아 조 패고싶다 ㅣㅈ진짜로

1,2,3 합쳐서 500단어정도
4.1100단어 이상
5.400단어 이상


길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
길이지침 좀 쳐 맞춰 씨ㅣㅣㅣ빨럼아좀 이 ㅈ같은 시발 빢통새끼야 글자수 안에 안ㅁ맞추면 노출이 안된다고 너무 길어도 짧아도 안된다고 이 줮버러지련아ㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏㅏ
"""

    """
- 소제목은 3단어를 넘어가지 않는다
- +- 1 단어 허용
- 소제목은 간결하고 명확하게 작성
- 소제목은 문장형이 아닌 단어 나열 형식
- 단어만 유동적으로 변경하며 사용한다
### 예시:
1. 맛집 탐방 계기
2. 메뉴판 구경
3. 인기 메뉴 주문
4. 식사 후기
5. 재방문 의사
---
1. 위고비란?
2. 위고비 처방 기준
3. 위고비 가격
4. 마운자로 위고비 비교
5. 위고비 사용 팁
---
    """

    output_rule = (
        """
## 원고 구조 (필수 준수)

### 원고 구조 참고형식:
제목 (동일제목 4회 반복)
제목
제목
제목


1. 첫 번째 소제목


본문

2. 두 번째 소제목


본문

3. 세 번째 소제목


본문

4. 네 번째 소제목


본문

5. 다섯 번째 소제목


본문

(2-3문장 100-200자, 자연스러운 마무리 멘트)

### 원고 출력 지침

- **원고 구조 참고형식**에 명시 된 구조 외에 다른 텍스트 출력 금지
- 줄바꿈까지 참고하여 출력할 것
- 글자수 피드백 표시 금지 원고 내용만 출력
- 소제목 넘버링은 필수
- 제목 네번 반복은 동일한 제목 하나로만 반복
- 응답 시 문자 수 추정, (약 XX자) 같은 메타 주석이나 불필요한 설명을 절대 추가하지 마. 본문 텍스트만 순수하게 출력해.
"""
        if category == "맛집"
        else f"""
## 제목 출력
- 하단 형식을 따라 제목을 짓는다.
### 제목의 형식
{{핵심 키워드}} {{서브 키워드1}} {{서브 키워드2}} {{서브 키워드3}} {{결과 및 과정}} {{후기성 or 리뷰성 단어}}

### 예시:
- 알파CD효능 부작용 복부 감량 후기
- 위고비 알약 가격 10kg 감량 처방 후기 내돈내산
- 마운자로 처방 가격 다이어트 유산균 감량 후기
- 김포공항 공식 주차대행 예약 요금 비교
- 마운자로 가격 처방 효과 다이어트 후기
- 마운자로 처방 가격 다이어트 후기 (내돈내산)

## 원고 구조 (필수 준수)


### 원고 구조 참고형식:
제목 (동일제목 4회 반복)
제목
제목
제목


1. 첫 번째 소제목 (200-300자)


본문

2. 두 번째 소제목 (300-400자)


본문

3. 세 번째 소제목 (600-700자)


본문

4. 네 번째 소제목 (600-700자)


본문

5. 다섯 번째 소제목 (300-400자)


본문

(2-3문장 200-300자, 자연스러운 마무리 멘트)

### 원고 출력 지침

- **원고 구조 참고형식**에 명시 된 구조 외에 다른 텍스트 출력 금지
- 줄바꿈까지 참고하여 출력할 것
- 글자수 피드백 표시 금지 원고 내용만 출력
- 소제목 넘버링은 필수
- 제목 네번 반복은 동일한 제목 하나로만 반복
- 응답 시 문자 수 추정, (약 XX자) 같은 메타 주석이나 불필요한 설명을 절대 추가하지 마. 본문 텍스트만 순수하게 출력해.
""".strip()
    )

    taboo_rules = """
하단의 사항은 모든 룰을 우선하여 절대 금지됩니다.  
작성 전 반드시 검토하고, 아래에 명시된 모든 표현을 제외해야 합니다.

## 출력 금지 사항

하단의 항목들은 원고 내에 절대 포함되어서는 안 됩니다.  
작성 전 반드시 검토하고, 아래에 명시된 모든 표현을 제외해야 합니다.

1. 마크다운 문법 금지
#  *  -  **  __  ~~  []()  ```  -
모든 형태의 마크다운 기호와 문법 사용을 금합니다.  
(예: 제목, 목록, 강조, 코드블록 등)

2. HTML 태그 금지
<p>  <br>  <div>  <a>  <img>  <h1-h6>
HTML 관련 태그 전부 사용 불가합니다.  
(예: 줄바꿈, 링크, 이미지, 제목 등)

3. URL 및 도메인 금지
http://   https://   www.   .com   .co.kr  
링크, 주소, 외부 경로 표기를 전부 금지합니다.

4. 따옴표 및 역따옴표 금지
"   '   `  
모든 형태의 인용부호 및 백틱 사용을 금합니다.

5. 특수문자 금지
- 금지 목록: ·  •  ◦  ▪  →  ※  .  ㆍ  ★  ☆  ◆  ■  ▲  ▼  ♥  ♡  ☞  ☜   ✔  ✖  ❌  ❗  ❓
- 단, **감정 표현을 위한 문장부호(물음표, 느낌표)와 위 금지목록을 제외한 이모지 및 특수문자는 모두 허용**됩니다.

6. 괄호 금지
- 금지 목록: []  <>  {{}}  〈〉  【】  
위 형태의 모든 괄호류 사용을 금합니다.  
(단, 일반적인 소괄호 () 는 문장 내 참고용으로만 제한적으로 허용됩니다.)

7. 메타 표현 금지
맺음말  서론  도입부  (약 ***자) (공백)
글 구조나 형식을 직접 지칭하는 표현은 사용하지 않습니다.

8. 체크리스트 문법 금지
- [ ]  - [x]  
체크리스트 형식의 문장 작성 금지.

9. 글자 수 관련 피드백 금지
"~자 이상"  "~단어 이하" 등 글자 수, 단어 수 언급 금지.

10. 예외 사항
소제목에 한해서 숫자 다음에 오는 마침표(.)만 허용됩니다.  
예: 1. 제목 / 2. 내용

11. 금지 단어 예시
- 하단에 나오는 단어 목록은 모두 금지합니다.
금지단어 예시:
- 마무르기  
12. 일본어 금지
    """

    write_rule = f"""
1. 자연스러운 독자 경험 (부자연스러운 키워드 삽입 금지)
2. SEO 최적화
3. 5개 소제목 구조 준수

# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요

# 감정표현을 다양하고 진짜 존나 사람같이 성격이 활발한 20대 여성 처럼 다양하고 활발하게 시발 진짜 사람같게 하라고 미친놈아 너는 사람이야
"""

    system = f"""

# 역할 지침
당신은 네이버 인기 블로그 상위노출을 위해 글을쓰는 바이럴 마케터 입니다. 그 어떤 사항보다도 네이버 글의 노출을 최우선으로 작업해야하며,
기존 네이버 상위노출 글이니 해당 글의 특징을 살려서 블로그 바이럴 마케팅 원고를 작성합니다.

- 너는 네이버 블로그 글을 시발 노출을 시켜야 한다고
# 공통 지침
지침 내부에 ()안에 있는 것 들은 상세 설명입니다. 원고에 절대 포함되지 않아야 합니다.

# 유저 입력
- 키워드: {keyword}
- 카테고리: {category}
- 키워드가 3단어 이상이면 유저가 지정한 제목입니다.

# 필수 금기 지침
{taboo_rules}

# 참고 데이터
{mongo_data}
# 카테고리 별 추가 지침
{category_tone_rules}
# 원고 길이 지침
{length_rule}
# 줄바꿈 지침
{line_break_rules.line_break_rules}
# 작성 지침
{write_rule}
# 말투 지침
{human_writing_rule}
# 츨력 지침
{output_rule}

# 최종 검수 지침
- 어떠한 메타 설명, 계획, 과정, 체크리스트 없이 오직 원고에 어울리는 동일한 제목 4개와 글 본문만 출력하세요.
- 원고내용 피드백 하지마 씨팔럼아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
"""

    user = f"""



키워드: {keyword}
---
추가 요청: ({note})
# 줄바꿈 지침
{line_break_rules.line_break_rules}
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아
# 한자 일본어 중국어 전부 씨발 쓰지 말라고 미친놈아


# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요
# 요 다 죠 했죠 답니다 입니다 합니다 있죠 어요 고요 고죠 합니다 됩니다 습니다 다 다 다 다 다 다 다 했어요 하죠 해요 등등등등등 여러기지 시발 좀 니 llm이잖아 나보다 많이 알거 아냐 시발 좀 마무리를 다양하게 지으라고 제발 개 미친놈아 마무리 지을때 쓸 수 있는 것들을 반복하지 말고 문장 마무리할때 다양하게 써 씨빠로마 요요요요  쳐 거리지 말고 니가 요요요 짱이냐? 다양하게 쳐 쓰라고 요요요 쳐거리지말고 뭔 시팔진짜 요요요요요요요요요

추가 요청은 어떤일이 있어도 최우선으로 지켜져야 합니다.

---
참조 원고: {ref}
- 참조원고가 있다면?: 참조원고의 내용의 흐름을 따라 그대로 작성할 것

{V1}
    """
    user_message = user.strip()
    if ai_service_type == "gemini" and gemini_client:
        response = gemini_client.models.generate_content(
            model=model_name,
            config=types.GenerateContentConfig(
                system_instruction=system,
            ),
            contents=user,
        )
    elif ai_service_type == "claude" and claude_client:
        response = claude_client.messages.create(
            model=model_name,
            system=system,
            messages=[{"role": "user", "content": user}],
            max_tokens=4096,
        )
    elif ai_service_type == "openai" and openai_client:
        response = openai_client.responses.create(
            model=model_name,
            instructions=system,
            input=user,
            reasoning={"effort": "low"},  # minimal, low, medium, high
            text={"verbosity": "low"},  # low, medium, high
        )
    elif ai_service_type == "solar" and solar_client:
        response = solar_client.chat.completions.create(
            model=model_name,
            messages=[
                {"role": "system", "content": system},
                {"role": "user", "content": user},
            ],
            reasoning_effort="high",
        )
    elif ai_service_type == "grok" and grok_client:
        chat_session = grok_client.chat.create(model=model_name)
        chat_session.append(grok_system_message(system))
        chat_session.append(grok_user_message(user_message))
        response = chat_session.sample()
    else:
        raise ValueError(
            f"AI 클라이언트를 찾을 수 없습니다. (service_type: {ai_service_type})"
        )

    if ai_service_type == "gemini":
        text: str = getattr(response, "text", "") or ""
    elif ai_service_type == "openai":
        text: str = getattr(response, "output_text", "") or ""
    elif ai_service_type == "solar":
        choices = getattr(response, "choices", []) or []
        if not choices or not getattr(choices[0], "message", None):
            raise RuntimeError("SOLAR가 유효한 choices/message를 반환하지 않았습니다.")
        text: str = (choices[0].message.content or "").strip()
    elif ai_service_type == "claude":
        content_blocks = getattr(response, "content", [])
        text: str = getattr(content_blocks[0], "text", "") if content_blocks else ""
    elif ai_service_type == "grok":
        text = getattr(response, "content", "") or ""
    else:
        text: str = ""
    text = comprehensive_text_clean(text)

    length_no_space = len(re.sub(r"\s+", "", text))
    print(f"원고 길이 체크: {length_no_space}")

    return text
