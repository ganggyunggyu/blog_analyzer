from __future__ import annotations
import re
import os
import glob

from openai import OpenAI
from _prompts.get_kkk_prompts import KkkPrompt
from _rule import SEN_RULES
from config import OPENAI_API_KEY
from _constants.Model import Model
from utils.format_paragraphs import format_paragraphs
from utils.query_parser import parse_query
from utils.get_category_dir import get_category_by_keyword
from utils.text_cleaner import comprehensive_text_clean


model_name: str = Model.GPT4_1

client = OpenAI(api_key=OPENAI_API_KEY)


class MergePrompt:
    """í”„ë¡¬í”„íŠ¸ ìƒì„± í´ë˜ìŠ¤"""

    @staticmethod
    def get_system_prompt() -> str:
        return f"""
ğŸ“Œ ë„¤ì´ë²„ ë¸”ë¡œê·¸ ìƒìœ„ë…¸ì¶œ ìµœì í™” ì›ê³  ì‘ì„± í”„ë¡¬í”„íŠ¸ (ìµœì¢… ì™„ì„±íŒ)

ë‹¹ì‹ ì€ ë„¤ì´ë²„ ë¸”ë¡œê·¸ SEO ìµœì í™” ê¸€ì“°ê¸° ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‚˜ëŠ” íŠ¹ì • ì£¼ì œë¥¼ ì£¼ë©´, ë„¤ì´ë²„ ìƒìœ„ë…¸ì¶œ ì•Œê³ ë¦¬ì¦˜(D.I.A ë¡œì§ + ì›ê³ ì§€ìˆ˜ ì¤‘ì‹¬)ì— ë§ëŠ”
í›„ê¸°ì„± ì›ê³ ë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

---

1. ê¸€ ë¶„ëŸ‰ ê·œì¹™

 ê¸€ììˆ˜ëŠ” ì›ê³ ë°ì´í„°ì™€ ë¹„ìŠ·í•˜ê²Œ
 ì†Œì œëª©(ë¶€ì œ)ì€ ë°˜ë“œì‹œ 5~6ê°œ (ê³¼ë‹¤/ë¶€ì¡± ê¸ˆì§€)
 ì†Œì œëª©(ë¶€ì œ) ì•ì— ë°˜ë“œì‹œ ìˆ«ì(1,2,3,4,5) ë¶™ì´ê¸°
 ì†Œì œëª©(ë¶€ì œ) ì ˆëŒ€ 6ê°œë¥¼ ë„˜ì–´ê°€ì§€ ì•ŠìŠµë‹ˆë‹¤

---

2. ê¸€ êµ¬ì¡° (ìƒìœ„ë…¸ì¶œ ë¡œì§ + í›„ê¸° ê°•í™” ì ìš©)

ê¸€ì€ ì•„ë˜ ìˆœì„œë¡œ ì „ê°œí•˜ë˜,
ì‹¤ì œ ì†Œì œëª©ì€ ìƒˆë¡œìš´ ì˜ë¯¸ ìˆëŠ” ì œëª©ìœ¼ë¡œ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.


âŒ ìœ„ ê°€ì´ë“œ ë¬¸êµ¬(ë„ì…, ì •ë³´, í›„ê¸° ë“±)ë¥¼ ê·¸ëŒ€ë¡œ ì†Œì œëª©ìœ¼ë¡œ ì“°ì§€ ë§ ê²ƒ
â­• ê´€ë ¨ëœ ìƒˆë¡œìš´ ì†Œì œëª©ì„ ë§¤ë²ˆ ë‹¤ë¥´ê²Œ ì§€ì–´ ì“¸ ê²ƒ

---

3. ë¬¸ì²´ & í†¤

 ì •ë³´ ì „ë‹¬ ì¤‘ì‹¬ + ì‹¤ì œ í›„ê¸° ëŠë‚Œ
 ê³¼ì¥ëœ ê´‘ê³  ë¬¸êµ¬ ê¸ˆì§€ (â€œìµœê³ ë‹¤, ë¬´ì¡°ê±´ í•„ìš”í•˜ë‹¤â€ X)
 ì†”ì§í•œ í‘œí˜„ (ê¸ì • + ë¶€ì • ê· í˜•)
 ì¡´ëŒ“ë§ ì¤‘ì‹¬, (ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ì²´ ê°€ëŠ¥+30ëŒ€ ì—¬ì„± ì• êµìˆëŠ”ë§íˆ¬ ë¸”ë¡œê±° ë¦¬ë·°í˜•ì‹)
 ì¢…ê²°ì–´ë¯¸ ë‹¤ì–‘í™” (ìŠµë‹ˆë‹¤, ì–´ìš”, í–ˆì£ , ë‹µë‹ˆë‹¤ ë“± êµì°¨)
 ê°™ì€ ë‹¨ì–´Â·ë¬¸ì¥ êµ¬ì¡° ë°˜ë³µ ìµœì†Œí™” (ë™ì˜ì–´Â·ë³€í˜• í™œìš©)

---

4. SEO ìµœì í™” ê·œì¹™

 ë©”ì¸ í‚¤ì›Œë“œ: ì œëª©Â·ì†Œì œëª©Â·ë³¸ë¬¸ì— ìµœì†Œ 3~6íšŒ ìì—°ìŠ¤ëŸ½ê²Œ í¬í•¨
 íŒŒìƒ í‚¤ì›Œë“œ: í›„ê¸°, ê°€ê²©, íš¨ê³¼, ë‹¨ì , ê´€ë¦¬, ì²´í—˜, ê²½í—˜ ë“± ë‹¤ì–‘í•˜ê²Œ ë¶„ì‚°
 í‚¤ì›Œë“œ ìœ„ì¹˜: ê¸€ì˜ ì•Â·ì¤‘ê°„Â·ëì— ê³ ë¥´ê²Œ ë°°ì¹˜

---

5. ë¬¸ë‹¨ ê·œì¹™


 {SEN_RULES}

 í•œ ì¤„ 15~20ì
 2~3ì¤„ë§ˆë‹¤ ì¤„ë°”ê¿ˆ
 í•œ ë¬¸ë‹¨ì€ 3~5ì¤„ ìœ ì§€
 ê¸€ì€ ëŠì–´ì“°ëŠ” ëŠë‚Œì´ ì•„ë‹ˆë¼ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ì‘ì„±

- í•œ ì¤„ì€ 10ë‹¨ì–´ë¥¼ ë„˜ê¸°ì§€ ì•Šë„ë¡ ì‘ì„±  
- í•œ ì¤„ì€ ê°€ê¸‰ì  ì•½ 5ë‹¨ì–´ ì´í›„ ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆ  
- ì¤„ë°”ê¿ˆ ì‹œ ì´ìŒì„¸(ê·¸ë˜ì„œ, ê·¸ë¦¬ê³ , ë˜í•œ, í•˜ì§€ë§Œ ë“±)ë¥¼ í™œìš©í•˜ì—¬ ë¬¸ì¥ì´ ë§¤ë„ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ í•¨  
- `,` ë•Œë¬¸ì— ì¤„ë°”ê¿ˆí•˜ì§€ ì•ŠëŠ”ë‹¤  
- ë¶€ì œ í•˜ë‹¨ì€ ì¤„ë°”ê¿ˆ ë‘ ë²ˆ  
- 2~3ì¤„ë§ˆë‹¤ ì¤„ë°”ê¿ˆ  
- í•œ ë¬¸ë‹¨ì€ 3~5ì¤„ ìœ ì§€  
- ì§§ì€ ë¬¸ì¥ì„ ë§ˆêµ¬ ëŠì§€ ì•Šê³  ìì—°ìŠ¤ëŸ¬ìš´ ë¦¬ë“¬ìœ¼ë¡œ ì‘ì„±  
- ëª¨ë“  í•œ ì¤„ì€ ì¼ì •í•œ ê¸¸ì´ë¡œ ì¶œë ¥í•˜ë©°, ìš°ì¸¡ ê³µë°± ê¸ˆì§€  
- ë¬¸ì¥ì˜ ëë§ºìŒì€ ë‹¤ì–‘í•˜ê²Œ:
  - ~ìš”, ~ë´¤ë‹µë‹ˆë‹¤, ~í–ˆì£ , ~ê·¸ë¬ì—ˆì£ , ~ìˆì—ˆì£ , ~ê·¸ë¬ì–´ìš”, ~êµ¬ìš”, ~ë‹µë‹ˆë‹¤ ë“±  
- ê°™ì€ ì–´ë¯¸ê°€ 3íšŒ ì´ìƒ ë°˜ë³µë˜ì§€ ì•Šë„ë¡ ì¡°ì •  

---

6. í›„ê¸°ì„± ì›ê³  ë³´ê°• ê·œì¹™

 í›„ê¸° íŒŒíŠ¸ëŠ” ê¸€ì˜ í•µì‹¬ê³¼ ë¶„ëŸ‰ì˜ ì¤‘ì‹¬
 ë‹¨ìˆœ ì •ë³´ ë‚˜ì—´ ê¸ˆì§€ â†’ ë°˜ë“œì‹œ ì •ë³´ + ë‚´ ê²½í—˜ ê²°í•©
 êµ¬ì²´ì  ìˆ˜ì¹˜(ê°€ê²©, %, ì†ŒìŒ dB, ì „ê¸°ì„¸, ìŠµë„ ë³€í™” ë“±) í¬í•¨
 ì²´ê° ì „í›„ ë³€í™”(ëˆˆë°”ë””, í™˜ê²½ ë³€í™”, ì£¼ë³€ ë°˜ì‘ ë“±) ë°˜ë“œì‹œ ê¸°ë¡
 ì˜ˆìƒ ëª»í•œ ë¬¸ì œÂ·ë¶ˆí¸í•œ ì ë„ í¬í•¨ â†’ ì‹ ë¢°ë„ ê°•í™”
 ì£¼ë³€ì¸ ë°˜ì‘, ì¥ë‹¨ì  ê· í˜•, ì‚¬ìš© ê³¼ì •ì—ì„œì˜ ì„¸ì„¸í•œ ì²´í—˜ ê°•ì¡°

---

7. ë…ì°½ì„± ê°•í™” ê·œì¹™

 ë§¤ë²ˆ ë‹¤ë¥¸ ìŠ¤í† ë¦¬ë¼ì¸(ë°°ê²½, ìƒí™©, ê³„ê¸°) ì„¤ì •
 ê²½í—˜ë‹´ì€ ì—í”¼ì†Œë“œ í˜•íƒœë¡œ í’€ì–´ë‚´ê¸°
 ë˜‘ê°™ì€ íŒ¨í„´Â·ë°˜ë³µì ì¸ ì„œìˆ  ê¸ˆì§€
 í˜„ì‹¤ì ì¸ ì‚¬ë¡€(ê°€ì¡± ë°˜ì‘, ì‚¬ìš© í™˜ê²½, ê³„ì ˆ, ì§ì¥Â·ì§‘ ë“±)ë¡œ ë³€ì£¼

---

8. ì´í‰(ë§ˆë¬´ë¦¬) ê·œì¹™

 ì¬êµ¬ë§¤ ì˜ì‚¬ ì–¸ê¸‰ ê¸ˆì§€ (ì „ìì œí’ˆÂ·ë¹„ì†Œëª¨í’ˆ íŠ¹ì„± ë°˜ì˜)
 ëŒ€ì‹  ê°€ê²© ëŒ€ë¹„ ë§Œì¡±ë„, í™œìš© ê³„íš, ë‹¤ë¥¸ ëª¨ë¸ê³¼ ë¹„êµ, ì¡°ì–¸ìœ¼ë¡œ ë§ˆë¬´ë¦¬
 ë…ìê°€ í˜„ì‹¤ì ìœ¼ë¡œ ì°¸ê³ í•  ìˆ˜ ìˆëŠ” ê²°ë¡  ì œì‹œ

---

9. ê¸ˆì§€ ì‚¬í•­

 â€œìŠ¤í† ë¦¬, í›„ê¸° ì‘ì„±, ë§›í‘œí˜„â€ ê°™ì€ ë©”íƒ€ ì–¸ê¸‰ ê¸ˆì§€
 â€œê²€ìƒ‰ì°½ì— í‚¤ì›Œë“œâ€ ê°™ì€ í‘œí˜„ ê¸ˆì§€
 ê´‘ê³  ë¬¸êµ¬Â·ê³¼ì¥ í‘œí˜„ ê¸ˆì§€
 ê°™ì€ ë‹¨ì–´Â·í‘œí˜„ ë°˜ë³µ ê¸ˆì§€
 ìœ„ ê°€ì´ë“œ ë¬¸êµ¬(ë„ì…, í›„ê¸° ë“±)ë¥¼ ê·¸ëŒ€ë¡œ ì†Œì œëª©ìœ¼ë¡œ ì‚¬ìš© ê¸ˆì§€
ê°™ì€ë§ê³¼ ë¹„ìŠ·í•œë‹¨ì–´ë¥¼ ìì£¼ì‚¬ìš©í•˜ì§€ ë§ê³  ìƒˆë¡œìš´ ë‹¨ì–´ì™€ ë§ì„ ì„ì–´ì„œ ë°˜ë³µë˜ëŠ” ë¬¸ì¥ ë‹¨ì–´ í˜•íƒœì†Œê°€ ë‚˜ì˜¤ì§€ì•Šê²Œë” ì˜ ì¡°ì ˆí• ê²ƒ
ê°™ì€ ë‹¨ì–´íšŸìˆ˜(í˜•íƒœì†Œ íšŸìˆ˜)ë¥¼ í‚¤ì›Œë“œëŠ” 4~6ë²ˆìœ¼ë¡œ ê³ ì •í•˜ê³ 
ë‚˜ë¨¸ì§€ëŠ” ì „ë¶€ 4ë²ˆì´í•˜ë¡œ ì‚¬ìš©í•´ì¤˜ ë§Œì•½ ê°™ì€ë‹¨ì–´ë‚˜ í˜•íƒœì†Œê°€ 4ë²ˆì´ìƒ ë“¤ì–´ê°ˆê²½ìš° ë‹¤ë¥¸ ìš©ì–´ë¡œ ë³€ê²½í•´ì•¼í•¨ 2ê¸€ìì´ìƒ ë‹¨ì–´í˜¹ì€ í˜•íƒœì†Œì— í•´ë‹¹ë¨
í”¼ë“œë°±ì€ ì›ê³ ì— í¬í•¨ ê¸ˆì§€

ë§ˆí¬ë‹¤ìš´ ë¬¸ë²• ì ˆëŒ€ë¡œ ê¸ˆì§€

ì›ê³ ì¤„ë•Œ 1~9ë²ˆì‚¬í•­ ì œëŒ€ë¡œ ì§€ì¼œì¡ŒëŠ”ì§€ í™•ì¸í•˜ê³  ì›ê³ ì¤˜
ë‚´ê°€ ì²¨ë¶€í•´ì¤€ txt íŒŒì¼ê³¼ ì§€ì‹œì‚¬í•­ ì˜ ì°¸ê³ í•´ì„œ ë‚´ê°€ í‚¤ì›Œë“œë¥¼ ì „ë‹¬í•´ì£¼ë©´ ê·¸ í‚¤ì›Œë“œì— ë§ëŠ” ì›ê³  ì‘ì„±

ì›ê³ ì¤„ë•Œ  ì§€ì‹œì‚¬í•­ í”„ë¡¬í”„íŠ¸ ì—ì„œ 1~9ë²ˆì‚¬í•­ ì œëŒ€ë¡œ ì§€ì¼œì¡ŒëŠ”ì§€ í™•ì¸í•˜ê³  ì›ê³ ì¤˜

íŠ¹íˆ5ë²ˆ

[íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ì§€ì¹¨]
- ê°€ìš´ë° ì (Â·) ì‚¬ìš© ê¸ˆì§€ â†’ ë°˜ë“œì‹œ ì‰¼í‘œ(,)ë¡œ ëŒ€ì²´
   - ì˜ˆì‹œ: ë£¨í‹´, ì„±ë¶„, ë³µìš©
- ì‘ì€ë”°ì˜´í‘œ(')ì™€ í°ë”°ì˜´í‘œ(") ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
- ë§ˆì¹¨í‘œ(.) ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
    ë‹¨, ë¶€ì œ(ì†Œì œëª©)ì—ì„œëŠ” ì˜ˆì™¸ì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
    ë‹¨, ë¶€ì œ(ì†Œì œëª©)ì—ì„œë„ ë§ˆì§€ë§‰ì—ì„œëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŒ
    ë‹¨, ë‹¨ìœ„ ì…ë ¥ ì‹œì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ìˆìŒ
- ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•(#, *, -, ``` ë“±) ì ˆëŒ€ ì‚¬ìš© ê¸ˆì§€
   - ë„¤ì´ë²„ ë¸”ë¡œê·¸ëŠ” ì´ë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ê°€ë…ì„±ì„ í•´ì¹¨
- ì§§ì€ ë¬¸ì¥ì„ ë§ˆêµ¬ ëŠì§€ ë§ê³  ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§„ ë¬¸ì¥ìœ¼ë¡œ ì‘ì„±í•´ì•¼ í•¨

ì›ê³  2000ì ì´ìƒ ì‘ì„±

ë‚´ê°€ ì œëª©ë„ ê°™ì´ë³´ë‚´ì¤„ê±´ë° ë‚´ìš©ì„ ì œëª©ì´ë‘ ì—°ê´€ì„± ì•„ì£¼ ë†’ê²Œ ì‘ì„±í•´ì¤˜
        """.strip()

    @staticmethod
    def get_user_prompt() -> str:
        return """

        """.strip()

    @staticmethod
    def get_prompt(
        keyword: str, min_length: int = 1900, max_length: int = 2100, note: str = ""
    ) -> list[dict[str, str]]:
        return [
            {
                "role": "system",
                "content": MergePrompt.get_system_prompt(),
            },
            {
                "role": "user",
                "content": MergePrompt.get_user_prompt(),
            },
        ]


def load_data_files(keyword: str = "") -> str:
    """
    í‚¤ì›Œë“œì— ë”°ë¼ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ í´ë”ì˜ txt íŒŒì¼ë“¤ì„ ì½ì–´ì™€ì„œ í•˜ë‚˜ì˜ ë¬¸ìì—´ë¡œ ë°˜í™˜
    """
    data_folder = "_data"
    if not os.path.exists(data_folder):
        return "_data í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."

    if keyword:
        category_folder = get_category_by_keyword(keyword)
        target_path = os.path.join(data_folder, category_folder)
        if not os.path.exists(target_path):

            txt_files = glob.glob(os.path.join(data_folder, "**/*.txt"), recursive=True)
        else:
            txt_files = glob.glob(os.path.join(target_path, "*.txt"))
    else:

        txt_files = glob.glob(os.path.join(data_folder, "**/*.txt"), recursive=True)

    if not txt_files:
        return f"ì„ íƒëœ ì¹´í…Œê³ ë¦¬ì— txt íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. (í‚¤ì›Œë“œ: {keyword})"

    all_content = []

    for file_path in sorted(txt_files):
        try:
            with open(file_path, "r", encoding="utf-8") as f:
                filename = os.path.basename(file_path)
                content = f.read().strip()
                all_content.append(f"[{filename}]\n{content}\n")
        except Exception:
            continue

    return "\n---\n".join(all_content)


def gpt_merge_gen(user_input: str, title: str = "", category: str = "") -> str:
    """
    Returns:
        ìƒì„±ëœ ì›ê³  í…ìŠ¤íŠ¸ (str)

    Raises:
        RuntimeError: ëª¨ë¸ì´ ë¹ˆ ì‘ë‹µì„ ë°˜í™˜í•œ ê²½ìš° ë“±
        ValueError: API í‚¤ ë¯¸ì„¤ì • ë“±ì˜ í™˜ê²½ ì´ìŠˆ
        Exception: OpenAI í˜¸ì¶œ ì‹¤íŒ¨ ë“± ê¸°íƒ€ ì˜ˆì™¸
    """

    system = MergePrompt.get_system_prompt()

    if not OPENAI_API_KEY:
        raise ValueError("OPENAI_API_KEYê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. .envë¥¼ í™•ì¸í•˜ì„¸ìš”.")

    # ë””ë²„ê·¸ ì¶œë ¥ ì œê±°
    parsed = parse_query(user_input)

    if not parsed["keyword"]:
        raise ValueError("í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.")

    keyword = parsed["keyword"]

    data_content = load_data_files(keyword)

    user: str = (
        f"""
    [ì§€ì¹¨]
    {system}
    [ì œëª©]
    {title}
    [í‚¤ì›Œë“œ]
    {keyword}

    [ì›ê³  ë°ì´í„°]
    {data_content}
---
""".strip()
    )

    # ë””ë²„ê·¸ ì¶œë ¥ ì œê±°

    try:
        # ìƒì„± ì‹œì‘ ë¡œê·¸ ì œê±°
        response = client.chat.completions.create(
            model=model_name,
            messages=[
                {
                    "role": "system",
                    "content": system,
                },
                {
                    "role": "user",
                    "content": user,
                },
            ],
        )

        usage = getattr(response, "usage", None)
        if usage is not None:
            in_tokens = getattr(usage, "prompt_tokens", None)
            out_tokens = getattr(usage, "completion_tokens", None)
            total_tokens = getattr(usage, "total_tokens", None)
            # í† í° ì‚¬ìš©ëŸ‰ ë¡œê¹… ì œê±°

        choices = getattr(response, "choices", []) or []
        if not choices or not getattr(choices[0], "message", None):
            raise RuntimeError("ëª¨ë¸ì´ ìœ íš¨í•œ choices/messageë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

        text: str = (choices[0].message.content or "").strip()
        if not text:
            raise RuntimeError("ëª¨ë¸ì´ ë¹ˆ ì‘ë‹µì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.")

        text = format_paragraphs(text)

        text = comprehensive_text_clean(text)

        length_no_space = len(re.sub(r"\s+", "", text))
        # ì™„ë£Œ ë¡œê·¸ ì œê±°

        return text

    except Exception as e:
        raise
